<!DOCTYPE HTML><html lang="zh-CN"><head><meta charset="utf-8"><meta name="keywords" content="无人机姿态估计（互补滤波）, JiangCS"><meta name="description" content=""><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><meta name="renderer" content="webkit|ie-stand|ie-comp"><meta name="mobile-web-app-capable" content="yes"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><title>无人机姿态估计（互补滤波） | JiangCS</title><link rel="icon" type="image/png" href="/favicon.png"><link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css"><link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css"><link rel="stylesheet" type="text/css" href="/libs/aos/aos.css"><link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css"><link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css"><link rel="stylesheet" type="text/css" href="/css/matery.css"><link rel="stylesheet" type="text/css" href="/css/my.css"><script src="/libs/jquery/jquery.min.js"></script><meta name="generator" content="Hexo 5.4.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head><body><header class="navbar-fixed"><nav id="headNav" class="bg-color nav-transparent"><div id="navContainer" class="nav-wrapper container"><div class="brand-logo"><a href="/" class="waves-effect waves-light"><img src="/medias/logo.png" class="logo-img" alt="LOGO"> <span class="logo-span">JiangCS</span></a></div><a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a><ul class="right nav-menu"><li class="hide-on-med-and-down nav-item"><a href="/" class="waves-effect waves-light"><i class="fas fa-home" style="zoom:.6"></i> <span>首页</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fas fa-tags" style="zoom:.6"></i> <span>标签</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fas fa-bookmark" style="zoom:.6"></i> <span>分类</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fas fa-archive" style="zoom:.6"></i> <span>归档</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/about" class="waves-effect waves-light"><i class="fas fa-user-circle" style="zoom:.6"></i> <span>关于</span></a></li><li class="hide-on-med-and-down nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fas fa-address-book" style="zoom:.6"></i> <span>友情链接</span></a></li><li><a href="#searchModal" class="modal-trigger waves-effect waves-light"><i id="searchIcon" class="fas fa-search" title="搜索" style="zoom:.85"></i></a></li></ul><div id="mobile-nav" class="side-nav sidenav"><div class="mobile-head bg-color"><img src="/medias/logo.png" class="logo-img circle responsive-img"><div class="logo-name">JiangCS</div><div class="logo-desc">Never really desperate, only the lost of the soul.</div></div><ul class="menu-list mobile-menu-list"><li class="m-nav-item"><a href="/" class="waves-effect waves-light"><i class="fa-fw fas fa-home"></i> 首页</a></li><li class="m-nav-item"><a href="/tags" class="waves-effect waves-light"><i class="fa-fw fas fa-tags"></i> 标签</a></li><li class="m-nav-item"><a href="/categories" class="waves-effect waves-light"><i class="fa-fw fas fa-bookmark"></i> 分类</a></li><li class="m-nav-item"><a href="/archives" class="waves-effect waves-light"><i class="fa-fw fas fa-archive"></i> 归档</a></li><li class="m-nav-item"><a href="/about" class="waves-effect waves-light"><i class="fa-fw fas fa-user-circle"></i> 关于</a></li><li class="m-nav-item"><a href="/friends" class="waves-effect waves-light"><i class="fa-fw fas fa-address-book"></i> 友情链接</a></li><li><div class="divider"></div></li><li><a href="https://github.com/Jcs-blog" class="waves-effect waves-light" target="_blank"><i class="fab fa-github-square fa-fw"></i>github</a></li></ul></div></div><style>.nav-transparent .github-corner{display:none!important}.github-corner{position:absolute;z-index:10;top:0;right:0;border:0;transform:scale(1.1)}.github-corner svg{color:#0f9d58;fill:#fff;height:64px;width:64px}.github-corner:hover .octo-arm{animation:a .56s ease-in-out}.github-corner .octo-arm{animation:none}@keyframes a{0%,to{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}</style><a href="https://github.com/Jcs-blog" class="github-corner tooltipped hide-on-med-and-down" target="_blank" data-tooltip="github" data-position="left" data-delay="50"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a></nav></header><script src="/libs/cryptojs/crypto-js.min.js"></script><script>(function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();</script><div class="bg-cover pd-header post-cover" style="background-image:url(/medias/featureimages/21.jpg)"><div class="container" style="right:0;left:0"><div class="row"><div class="col s12 m12 l12"><div class="brand"><h1 class="description center-align post-title">无人机姿态估计（互补滤波）</h1></div></div></div></div></div><main class="post-container content"><link rel="stylesheet" href="/libs/tocbot/tocbot.css"><style>#articleContent h1::before,#articleContent h2::before,#articleContent h3::before,#articleContent h4::before,#articleContent h5::before,#articleContent h6::before{display:block;content:" ";height:100px;margin-top:-100px;visibility:hidden}#articleContent :focus{outline:0}.toc-fixed{position:fixed;top:64px}.toc-widget{width:345px;padding-left:20px}.toc-widget .toc-title{padding:35px 0 15px 17px;font-size:1.5rem;font-weight:700;line-height:1.5rem}.toc-widget ol{padding:0;list-style:none}#toc-content{padding-bottom:30px;overflow:auto}#toc-content ol{padding-left:10px}#toc-content ol li{padding-left:10px}#toc-content .toc-link:hover{color:#42b983;font-weight:700;text-decoration:underline}#toc-content .toc-link::before{background-color:transparent;max-height:25px;position:absolute;right:23.5vw;display:block}#toc-content .is-active-link{color:#42b983}#floating-toc-btn{position:fixed;right:15px;bottom:76px;padding-top:15px;margin-bottom:0;z-index:998}#floating-toc-btn .btn-floating{width:48px;height:48px}#floating-toc-btn .btn-floating i{line-height:48px;font-size:1.4rem}</style><div class="row"><div id="main-content" class="col s12 m12 l9"><div id="artDetail"><div class="card"><div class="card-content article-info"><div class="row tag-cate"><div class="col s7"><div class="article-tag"><a href="/tags/%E6%97%A0%E4%BA%BA%E6%9C%BA%E7%AE%97%E6%B3%95/"><span class="chip bg-color">无人机算法</span></a></div></div><div class="col s5 right-align"></div></div><div class="post-info"><div class="post-date info-break-policy"><i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp; 2021-01-13</div><div class="post-date info-break-policy"><i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp; 2021-01-13</div><div class="info-break-policy"><i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp; 7.1k</div><div class="info-break-policy"><i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp; 31 分</div></div></div><hr class="clearfix"><div class="card-content article-card-content"><div id="articleContent"><blockquote><p>前言：多旋翼的姿态估计算法通常采用自适应显示<code>互补滤波算法</code>、<code>扩展卡尔曼滤波算法</code>、<code>梯度下降算法</code>等，以上三种方法均是对姿态解算的实现，采用的基本思路都是利用陀螺仪的动态稳定性来估计实时姿态，同时由于陀螺仪随时间积分累计漂移误差的固有缺陷，需找一个不随时间变化影响的传感器来估计姿态并进行修正标定。三种方法各有优缺点，互补与梯度算法更适用于处理性能受限的飞行器，例如微型四轴等采用低频<code>Cortex-M0</code>或<code>M1</code>的处理器，而在条件允许性能足够的情况下，建议考虑采用扩展卡尔曼滤波的算法</p></blockquote><blockquote><p><code>PX4</code> 源码中采用的是改进的互补滤波算法，在原有加速度计校准陀螺仪的基础上，增加磁力计和<code>GPS</code>数据进行更进一步的四元数校准补偿，它的优点是运算简单，因此成为<code>PX4</code>中默认的姿态解算算法</p></blockquote><p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/wb790238030/article/details/86710954">【算法基础学习 4】互补滤波算法——PX4姿态估计</a></p><p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a target="_blank" rel="noopener" href="https://blog.csdn.net/xl__max/article/details/105564102?utm_medium=distribute.pc_relevant_download.none-task-blog-baidujs-1.nonecase&depth_1-utm_source=distribute.pc_relevant_download.none-task-blog-baidujs-1.nonecase">PX4源码分析3：attitude_estimator_q</a></p><p>&emsp;&emsp;&emsp;&emsp;&emsp;&emsp;<a target="_blank" rel="noopener" href="https://blog.csdn.net/newworld123made/article/details/51449739">施密特正交化</a></p><blockquote><p><strong>固件版本：V1.11.3</strong></p></blockquote><hr><h1 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h1><h2 id="陀螺仪"><a href="#陀螺仪" class="headerlink" title="陀螺仪"></a>陀螺仪</h2><p>&emsp;&emsp;<strong>陀螺仪</strong>，测量角速度，具有高动态特性，它是一个间接测量角度的器件。它测量的是角度的导数，即角速度，要将角速度对时间积分才能得到角度。由于噪声等误差影响，在积分作用下不断积累，最终导致陀螺仪的低频干扰和漂移。</p><h2 id="加速度计"><a href="#加速度计" class="headerlink" title="加速度计"></a>加速度计</h2><p>&emsp;&emsp;输出当前加速度（包含重力加速度 g）的方向【也叫重力感应器】，在悬停时，输出为 g。由其测量原理导致的高频信号敏感，使得<code>加速度计在振动环境中高频干扰较大</code>。</p><h2 id="磁力计（又叫磁罗盘）"><a href="#磁力计（又叫磁罗盘）" class="headerlink" title="磁力计（又叫磁罗盘）"></a>磁力计（又叫磁罗盘）</h2><p>&emsp;&emsp;输出为当前机体与地磁场的夹角。测量原理与指南针相似。低频特性较好，易受周围磁场干扰。<br>磁力计的工作原理参考：<a target="_blank" rel="noopener" href="http://blog.sina.com.cn/s/blog_402c071e0102v8ig.html">http://blog.sina.com.cn/s/blog_402c071e0102v8ig.html</a></p><h2 id="坐标系"><a href="#坐标系" class="headerlink" title="坐标系"></a>坐标系</h2><ul><li><strong>导航坐标系</strong>：在多旋翼中，又叫地球坐标系、地理坐标系。通常，采用北东地（NED）构成坐标系的 X,Y,Z 轴。</li><li><strong>机体坐标系</strong> ：固联在多旋翼飞行器上，即，坐标系原点定位于飞行器中心点（假设中心点与重心点重合）。</li></ul><p>关于航空导航用到的坐标系，请参考 AIAA 系列丛书。在多旋翼中，因为只在低空飞行，且时间较短，只需要以上两个。</p><h2 id="姿态表示"><a href="#姿态表示" class="headerlink" title="姿态表示"></a>姿态表示</h2><ul><li><strong>欧拉角</strong> ：较直观，描述刚体在三维欧式空间中的姿态。此时，坐标系为机体坐标系，随着刚体的旋转而旋转。缺点：万向节锁。</li><li><strong>四元数</strong>：由一组四维向量，表示刚体的三维旋转。适合用于计算机计算。</li><li><strong>方向余弦矩阵DCM</strong>：用<code>欧拉角余弦值</code>或<code>四元数</code>，表示的<code>坐标系的旋转</code>。</li></ul><h1 id="滤波原理"><a href="#滤波原理" class="headerlink" title="滤波原理"></a>滤波原理</h1><p>&emsp;&emsp;互补滤波要求两个信号的<strong>干扰噪声处在不同的频率</strong>，通过设置两个滤波器的截止频率，确保融合后的信号能够覆盖需求频率。<br>&emsp;&emsp;在 IMU 的姿态估计中，<code>互补滤波器对陀螺仪（低频噪声）使用高通滤</code>波；对<code>加速度/磁力计（高频噪声）使用低频滤波</code>。</p><p>&emsp;&emsp;互补滤波中，两个滤波器的截止频率一致，此时就需要根据有用频率的值对其进行取舍。</p><p>&emsp;&emsp;机体水平时，加速度计无法测量绕 Z 轴的旋转量，即偏航角。磁力计也有同样问题，无法测得要磁轴的旋转量。故，需要加速度计和磁力计同时对陀螺仪进行校正。</p><h1 id="无人机姿态估计部分"><a href="#无人机姿态估计部分" class="headerlink" title="无人机姿态估计部分"></a>无人机姿态估计部分</h1><h2 id="头文件部分代码"><a href="#头文件部分代码" class="headerlink" title="头文件部分代码"></a>头文件部分代码</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">//调用无人机姿态以及参数部分的头文件</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;float.h></span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> &lt;drivers/drv_hrt.h</span><span class="token comment" spellcheck="true">//高精度的定时器。 在控制过程中多数环节都是使用经典的PID控制算法为</span>
<span class="token comment" spellcheck="true">//了获取较为实时的响应最重要的时间变量，这就涉及如何获取高精度的时间问题。pixhawk中就有高精度的RTC（实时时钟），这个</span>
<span class="token comment" spellcheck="true">//头文件就做了介绍</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;lib/ecl/geo/geo.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;lib/ecl/geo_lookup/geo_mag_declination.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;lib/mathlib/mathlib.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;lib/parameters/param.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;matrix/math.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;px4_platform_common/defines.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;px4_platform_common/module.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;px4_platform_common/module_params.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;px4_platform_common/posix.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/Publication.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/Subscription.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/SubscriptionCallback.hpp></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/parameter_update.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/sensor_combined.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/vehicle_attitude.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/vehicle_gps_position.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/vehicle_local_position.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/vehicle_magnetometer.h></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;uORB/topics/vehicle_odometry.h></span></span>
</code></pre><h2 id="using关键字"><a href="#using关键字" class="headerlink" title="using关键字"></a>using关键字</h2><pre class="language-c"><code class="language-c">using matrix<span class="token punctuation">:</span><span class="token punctuation">:</span>Dcmf<span class="token punctuation">;</span>

using matrix<span class="token punctuation">:</span><span class="token punctuation">:</span>Eulerf<span class="token punctuation">;</span>

using matrix<span class="token punctuation">:</span><span class="token punctuation">:</span>Quatf<span class="token punctuation">;</span>

using matrix<span class="token punctuation">:</span><span class="token punctuation">:</span>Vector3f<span class="token punctuation">;</span>

using matrix<span class="token punctuation">:</span><span class="token punctuation">:</span>wrap_pi<span class="token punctuation">;</span>
</code></pre><p><strong>using关键字：</strong>表示引入名称到 using 说明出现的声明区域</p><h2 id="类的定义"><a href="#类的定义" class="headerlink" title="类的定义"></a>类的定义</h2><pre class="language-c"><code class="language-c">class AttitudeEstimatorQ <span class="token punctuation">:</span> public ModuleBase<span class="token operator">&lt;</span>AttitudeEstimatorQ<span class="token operator">></span><span class="token punctuation">,</span> public ModuleParams<span class="token punctuation">,</span> public px4<span class="token punctuation">:</span><span class="token punctuation">:</span>WorkItem
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
public<span class="token punctuation">:</span>

    <span class="token function">AttitudeEstimatorQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">~</span><span class="token function">AttitudeEstimatorQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** @see ModuleBase */</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">task_spawn</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** @see ModuleBase */</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">custom_command</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/** @see ModuleBase */</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">print_usage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>reason <span class="token operator">=</span> nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    bool <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//初始化函数</span>

private<span class="token punctuation">:</span>

    <span class="token keyword">void</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">update_parameters</span><span class="token punctuation">(</span>bool force <span class="token operator">=</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

    bool <span class="token function">init_attq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    bool <span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//dt是更新周期，这个函数是整个程序的核心</span>

    <span class="token comment" spellcheck="true">// Update magnetic declination (in rads) immediately changing yaw rotation</span>
    <span class="token comment" spellcheck="true">//更新磁偏角( in rads )，立即改变偏航旋转</span>
    <span class="token comment" spellcheck="true">//偏航角改变立刻更新磁方位角</span>
    <span class="token keyword">void</span> <span class="token function">update_mag_declination</span><span class="token punctuation">(</span><span class="token keyword">float</span> new_declination<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">const</span> <span class="token keyword">float</span> _eo_max_std_dev <span class="token operator">=</span> <span class="token number">100.0f</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/**&lt; Maximum permissible standard deviation for estimated orientation */</span>
    <span class="token comment" spellcheck="true">//估计方位的最大允许标准差</span>

    <span class="token keyword">const</span> <span class="token keyword">float</span> _dt_min <span class="token operator">=</span> <span class="token number">0.00001f</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//dt是指更新数据的时间间隔，也就是离散pid公式中的T</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> _dt_max <span class="token operator">=</span> <span class="token number">0.02f</span><span class="token punctuation">;</span>

    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>SubscriptionCallbackWorkItem _sensors_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>this<span class="token punctuation">,</span> <span class="token function">ORB_ID</span><span class="token punctuation">(</span>sensor_combined<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription        _parameter_update_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>parameter_update<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription        _gps_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>vehicle_gps_position<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription        _local_position_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>vehicle_local_position<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription        _vision_odom_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>vehicle_visual_odometry<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//在topicvehicle_odometry里面</span>
    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription        _mocap_odom_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>vehicle_mocap_odometry<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Subscription        _magnetometer_sub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>vehicle_magnetometer<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//无人机姿态数据发布</span>
    uORB<span class="token punctuation">:</span><span class="token punctuation">:</span>Publication<span class="token operator">&lt;</span>vehicle_attitude_s<span class="token operator">></span>    _att_pub<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token function">ORB_ID</span><span class="token punctuation">(</span>vehicle_attitude<span class="token punctuation">)</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span>        _lockstep_component<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span>        _mag_decl<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token number">0.0f</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**磁方位角**/</span>
    <span class="token keyword">float</span>        _bias_max<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token number">0.0f</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**最大偏差**/</span>

    Vector3f    _gyro<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//通过陀螺仪获取的三轴的角速度</span>
    Vector3f    _accel<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//通过加速度计获取的三轴的加速度</span>
    Vector3f    _mag<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//通过磁力计获取的磁航向</span>

    Vector3f    _vision_hdg<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//视觉位置估计;</span>
    Vector3f    _mocap_hdg<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//vicon姿态位置估计;</span>

    Quatf        _q<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//四元数</span>
    Vector3f    _rates<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//姿态角速度  与上面_gyro不同的是这个用于存放修正后的绕三轴角速度</span>
    Vector3f    _gyro_bias<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//陀螺仪偏差</span>

    Vector3f    _vel_prev<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//前一刻加速度</span>

    <span class="token comment" spellcheck="true">//绝对时间</span>
    hrt_abstime    _vel_prev_t<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token number">0</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//前一时刻计算速度时的绝对时间   用于后面根据速度差除以时间差求加速度</span>

    Vector3f    _pos_acc<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//运动加速度，注意：这个加速度不包括垂直方向的</span>

    hrt_abstime    _last_time<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token number">0</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>

    bool        _inited<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>false<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//初始化标识;</span>
    bool        _data_good<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>false<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//数据可用;</span>
    bool        _ext_hdg_good<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>false<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//外部航向可用;</span>

    <span class="token comment" spellcheck="true">//参数定义</span>
    <span class="token comment" spellcheck="true">/**前面带w都是权重的意思**/</span>
    <span class="token function">DEFINE_PARAMETERS</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_ACC<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_acc<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//加速度计权重  0.2f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_MAG<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_mag<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//磁力计权重  0.1f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_EXT_HDG<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_ext_hdg<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//外部航向权重  0.1f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_GYRO_BIAS<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_gyro_bias<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//陀螺仪偏差权重  0.1f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_MAG_DECL<span class="token operator">></span><span class="token punctuation">)</span> _param_att_mag_decl<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//磁偏角（°）  0.0f</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_MAG_DECL_A<span class="token operator">></span><span class="token punctuation">)</span> _param_att_mag_decl_a<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//启用基于GPS的自动磁偏角校正  1</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_EXT_HDG_M<span class="token operator">></span><span class="token punctuation">)</span> _param_att_ext_hdg_m<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//外部航向模式  0</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_ACC_COMP<span class="token operator">></span><span class="token punctuation">)</span> _param_att_acc_comp<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 启用基于GPS速度的加速度补偿  1</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_BIAS_MAX<span class="token operator">></span><span class="token punctuation">)</span> _param_att_bias_mas<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//陀螺仪偏差上限  0.05f</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>SYS_HAS_MAG<span class="token operator">></span><span class="token punctuation">)</span> _param_sys_has_mag   <span class="token comment" spellcheck="true">//振动水平报警阈值  0.2f</span>
    <span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
</code></pre><h2 id="参数定义"><a href="#参数定义" class="headerlink" title="参数定义"></a>参数定义</h2><pre class="language-c"><code class="language-c">    <span class="token comment" spellcheck="true">//参数定义</span>
    <span class="token comment" spellcheck="true">/**前面带w都是权重的意思**/</span>
    <span class="token function">DEFINE_PARAMETERS</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_ACC<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_acc<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//加速度计权重  0.2f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_MAG<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_mag<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//磁力计权重  0.1f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_EXT_HDG<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_ext_hdg<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//外部航向权重  0.1f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_W_GYRO_BIAS<span class="token operator">></span><span class="token punctuation">)</span> _param_att_w_gyro_bias<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//陀螺仪偏差权重  0.1f</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_MAG_DECL<span class="token operator">></span><span class="token punctuation">)</span> _param_att_mag_decl<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//磁偏角（°）  0.0f</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_MAG_DECL_A<span class="token operator">></span><span class="token punctuation">)</span> _param_att_mag_decl_a<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//启用基于GPS的自动磁偏角校正  1</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_EXT_HDG_M<span class="token operator">></span><span class="token punctuation">)</span> _param_att_ext_hdg_m<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//外部航向模式  0</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_ACC_COMP<span class="token operator">></span><span class="token punctuation">)</span> _param_att_acc_comp<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// 启用基于GPS速度的加速度补偿  1</span>
        <span class="token punctuation">(</span>ParamFloat<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>ATT_BIAS_MAX<span class="token operator">></span><span class="token punctuation">)</span> _param_att_bias_mas<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//陀螺仪偏差上限  0.05f</span>
        <span class="token punctuation">(</span>ParamInt<span class="token operator">&lt;</span>px4<span class="token punctuation">:</span><span class="token punctuation">:</span>params<span class="token punctuation">:</span><span class="token punctuation">:</span>SYS_HAS_MAG<span class="token operator">></span><span class="token punctuation">)</span> _param_sys_has_mag   <span class="token comment" spellcheck="true">//振动水平报警阈值  0.2f</span>
    <span class="token punctuation">)</span>
</code></pre><h2 id="初始化赋值"><a href="#初始化赋值" class="headerlink" title="初始化赋值"></a>初始化赋值</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">//数据的初始化</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">AttitudeEstimatorQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">:</span>
    <span class="token function">ModuleParams</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">WorkItem</span><span class="token punctuation">(</span>MODULE_NAME<span class="token punctuation">,</span> px4<span class="token punctuation">:</span><span class="token punctuation">:</span>wq_configurations<span class="token punctuation">:</span><span class="token punctuation">:</span>nav_and_controllers<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    _vel_prev<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**清零**/</span>
    _pos_acc<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _gyro<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _accel<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _mag<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _vision_hdg<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**通过视觉得到的航向清零**/</span>
    _mocap_hdg<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**通过mocap得到的航向清零**/</span>

    _q<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _rates<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _gyro_bias<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">update_parameters</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    _lockstep_component <span class="token operator">=</span> <span class="token function">px4_lockstep_register_component</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><h2 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">//析构函数，清除所有任务</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">AttitudeEstimatorQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token function">px4_lockstep_unregister_component</span><span class="token punctuation">(</span>_lockstep_component<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">//初始化函数</span>
bool
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_sensors_sub<span class="token punctuation">.</span><span class="token function">registerCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">PX4_ERR</span><span class="token punctuation">(</span><span class="token string">"sensor combined callback registration failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><h2 id="Run函数"><a href="#Run函数" class="headerlink" title="Run函数"></a>Run函数</h2><pre class="language-c"><code class="language-c"><span class="token keyword">void</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">should_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        _sensors_sub<span class="token punctuation">.</span><span class="token function">unregisterCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit_and_cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    sensor_combined_s sensors<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//如果参数更新，进入下面的函数</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_sensors_sub<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sensors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//参数更新</span>
        <span class="token comment" spellcheck="true">//根据此偏角更新四元数</span>
        <span class="token function">update_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Feed validator with recent sensor data</span>
        <span class="token comment" spellcheck="true">//用近期数据填充验证器，做数据验证</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sensors<span class="token punctuation">.</span>timestamp <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">_gyro</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> sensors<span class="token punctuation">.</span>gyro_rad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_gyro</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> sensors<span class="token punctuation">.</span>gyro_rad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_gyro</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> sensors<span class="token punctuation">.</span>gyro_rad<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sensors<span class="token punctuation">.</span>accelerometer_timestamp_relative <span class="token operator">!=</span> sensor_combined_s<span class="token punctuation">:</span><span class="token punctuation">:</span>RELATIVE_TIMESTAMP_INVALID<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">_accel</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> sensors<span class="token punctuation">.</span>accelerometer_m_s2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_accel</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> sensors<span class="token punctuation">.</span>accelerometer_m_s2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">_accel</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> sensors<span class="token punctuation">.</span>accelerometer_m_s2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">//length函数为平方和开方</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>_accel<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.01f</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">PX4_ERR</span><span class="token punctuation">(</span><span class="token string">"degenerate accel!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Update magnetometer 磁力计</span>
        <span class="token comment" spellcheck="true">//如果数据更新，就将数据进行赋值</span>
        <span class="token comment" spellcheck="true">//topic 里面定义变量只有magnetometer_ga[3]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_magnetometer_sub<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            vehicle_magnetometer_s magnetometer<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_magnetometer_sub<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>magnetometer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token function">_mag</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> magnetometer<span class="token punctuation">.</span>magnetometer_ga<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">_mag</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> magnetometer<span class="token punctuation">.</span>magnetometer_ga<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">_mag</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> magnetometer<span class="token punctuation">.</span>magnetometer_ga<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>_mag<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.01f</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token function">PX4_ERR</span><span class="token punctuation">(</span><span class="token string">"degenerate mag!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        _data_good <span class="token operator">=</span> true<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Update vision and motion capture heading</span>
        <span class="token comment" spellcheck="true">//更新视觉和运动捕捉标题</span>
        _ext_hdg_good <span class="token operator">=</span> false<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_vision_odom_sub<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            vehicle_odometry_s vision<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_vision_odom_sub<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vision<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// validation check for vision attitude data</span>
                <span class="token comment" spellcheck="true">//视觉姿态数据的验证检查</span>

                <span class="token comment" spellcheck="true">// vision_att_valid 是bool类型的 主要进行判断，但是里面的数据表示什么意思？</span>
                bool vision_att_valid <span class="token operator">=</span> <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span>vision<span class="token punctuation">.</span>q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span>vision<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>vision<span class="token punctuation">.</span>COVARIANCE_MATRIX_ROLL_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span><span class="token function">fmaxf</span><span class="token punctuation">(</span>
                                    vision<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>vision<span class="token punctuation">.</span>COVARIANCE_MATRIX_ROLL_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                    <span class="token function">fmaxf</span><span class="token punctuation">(</span>vision<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>vision<span class="token punctuation">.</span>COVARIANCE_MATRIX_PITCH_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                            vision<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>vision<span class="token punctuation">.</span>COVARIANCE_MATRIX_YAW_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> _eo_max_std_dev <span class="token punctuation">:</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//如果有效</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>vision_att_valid<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">//将基于视觉得到的四元数赋值给新建的math::q</span>

                    <span class="token comment" spellcheck="true">//得到转换矩阵，将视觉的到的四元数转换为转换矩阵</span>
                    Dcmf Rvis <span class="token operator">=</span> <span class="token function">Quatf</span><span class="token punctuation">(</span>vision<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">//这是一个指北向量   至于0.4f是啥？</span>
                    Vector3f <span class="token function">v</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.4f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// Rvis is Rwr (robot respect to world) while v is respect to world.</span>
                    <span class="token comment" spellcheck="true">// Rvis是Rwr (机器人对世界的关系)，v是对世界的关系。</span>
                    <span class="token comment" spellcheck="true">//v是基于世界坐标  dcm是由b --> e需要进行转置</span>

                    <span class="token comment" spellcheck="true">// Hence Rvis must be transposed having (Rwr)' * Vw</span>
                    <span class="token comment" spellcheck="true">// 因此Rvis必须转置有( Rwr ) ' * Vw</span>
                    <span class="token comment" spellcheck="true">// Rrw * Vw = vn. This way we have consistency</span>
                    <span class="token comment" spellcheck="true">// Rrw * Vw = vn。这样我们就有了一致性</span>

                    <span class="token comment" spellcheck="true">//transpose()  转置的意思</span>
                    _vision_hdg <span class="token operator">=</span> Rvis<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">;</span><span class="token comment" spellcheck="true">/**转置后与v乘，就反映了视觉上的指北的向量**/</span>

                    <span class="token comment" spellcheck="true">// vision external heading usage (ATT_EXT_HDG_M 1)</span>
                    <span class="token comment" spellcheck="true">// 视觉外部标题用法</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_ext_hdg_m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Check for timeouts on data</span>
                        <span class="token comment" spellcheck="true">// 检查数据超时情况</span>
                        _ext_hdg_good <span class="token operator">=</span> vision<span class="token punctuation">.</span>timestamp_sample <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">hrt_elapsed_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vision<span class="token punctuation">.</span>timestamp_sample<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_mocap_odom_sub<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            vehicle_odometry_s mocap<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_mocap_odom_sub<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mocap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// validation check for mocap attitude data</span>
                bool mocap_att_valid <span class="token operator">=</span> <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span>mocap<span class="token punctuation">.</span>q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                               <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span>mocap<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>mocap<span class="token punctuation">.</span>COVARIANCE_MATRIX_ROLL_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">sqrtf</span><span class="token punctuation">(</span><span class="token function">fmaxf</span><span class="token punctuation">(</span>
                                       mocap<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>mocap<span class="token punctuation">.</span>COVARIANCE_MATRIX_ROLL_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                       <span class="token function">fmaxf</span><span class="token punctuation">(</span>mocap<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>mocap<span class="token punctuation">.</span>COVARIANCE_MATRIX_PITCH_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                               mocap<span class="token punctuation">.</span>pose_covariance<span class="token punctuation">[</span>mocap<span class="token punctuation">.</span>COVARIANCE_MATRIX_YAW_VARIANCE<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> _eo_max_std_dev <span class="token punctuation">:</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mocap_att_valid<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    Dcmf Rmoc <span class="token operator">=</span> <span class="token function">Quatf</span><span class="token punctuation">(</span>mocap<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Vector3f <span class="token function">v</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.4f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// Rmoc is Rwr (robot respect to world) while v is respect to world.</span>
                    <span class="token comment" spellcheck="true">// Hence Rmoc must be transposed having (Rwr)' * Vw</span>
                    <span class="token comment" spellcheck="true">// Rrw * Vw = vn. This way we have consistency</span>
                    _mocap_hdg <span class="token operator">=</span> Rmoc<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> v<span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">// Motion Capture external heading usage (ATT_EXT_HDG_M 2)</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_ext_hdg_m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// Check for timeouts on data</span>
                        _ext_hdg_good <span class="token operator">=</span> mocap<span class="token punctuation">.</span>timestamp_sample <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">hrt_elapsed_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mocap<span class="token punctuation">.</span>timestamp_sample<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">500000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_gps_sub<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            vehicle_gps_position_s gps<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_gps_sub<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>gps<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//磁力计</span>
                <span class="token comment" spellcheck="true">//首先检测是否配置了自动磁方位角获取，即用下面的if</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_mag_decl_a<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>gps<span class="token punctuation">.</span>eph <span class="token operator">&lt;</span> <span class="token number">20.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/* set magnetic declination automatically */</span>
                    <span class="token comment" spellcheck="true">// 自动设置磁偏角</span>
                    <span class="token comment" spellcheck="true">//自动获取磁方位角，如果配置了则用当前的经纬度（longitude and latitude）</span>
                    <span class="token comment" spellcheck="true">// 通过get_mag_declination(_gpos.lat,_gpos.lon)函数获取当前位置的磁偏角</span>
                    <span class="token function">update_mag_declination</span><span class="token punctuation">(</span><span class="token function">get_mag_declination_radians</span><span class="token punctuation">(</span>gps<span class="token punctuation">.</span>lat<span class="token punctuation">,</span> gps<span class="token punctuation">.</span>lon<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">//如果配置则使用当前磁偏角</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">// 本地位置更新</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_local_position_sub<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            vehicle_local_position_s lpos<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_local_position_sub<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lpos<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">//加速度计</span>
                <span class="token comment" spellcheck="true">//获取机体加速度，通过计算速度计算机体加速度</span>
                <span class="token comment" spellcheck="true">//先判断位置信息是否有效</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_acc_comp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token function">hrt_elapsed_time</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lpos<span class="token punctuation">.</span>timestamp<span class="token punctuation">)</span> <span class="token operator">&lt;</span> 20_ms<span class="token punctuation">)</span>
                    <span class="token operator">&amp;&amp;</span> lpos<span class="token punctuation">.</span>v_xy_valid <span class="token operator">&amp;&amp;</span> lpos<span class="token punctuation">.</span>v_z_valid <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>lpos<span class="token punctuation">.</span>eph <span class="token operator">&lt;</span> <span class="token number">5.0f</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> _inited<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">/* position data is actual */</span>
                    <span class="token keyword">const</span> Vector3f <span class="token function">vel</span><span class="token punctuation">(</span>lpos<span class="token punctuation">.</span>vx<span class="token punctuation">,</span> lpos<span class="token punctuation">.</span>vy<span class="token punctuation">,</span> lpos<span class="token punctuation">.</span>vz<span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token comment" spellcheck="true">/* velocity updated */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>_vel_prev_t <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lpos<span class="token punctuation">.</span>timestamp <span class="token operator">!=</span> _vel_prev_t<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                        <span class="token keyword">float</span> vel_dt <span class="token operator">=</span> <span class="token punctuation">(</span>lpos<span class="token punctuation">.</span>timestamp <span class="token operator">-</span> _vel_prev_t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1e6f</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">/* calculate acceleration in body frame */</span>
                        <span class="token comment" spellcheck="true">// 计算机体的加速度</span>
                        <span class="token comment" spellcheck="true">// 计算e系下的运动加速度，这里的pos_acc很重要，要用于后面加速度计的校正</span>
                        _pos_acc <span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate_inversed</span><span class="token punctuation">(</span><span class="token punctuation">(</span>vel <span class="token operator">-</span> _vel_prev<span class="token punctuation">)</span> <span class="token operator">/</span> vel_dt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

                    _vel_prev_t <span class="token operator">=</span> lpos<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//为迭代做准备</span>

                    <span class="token comment" spellcheck="true">//上一次的，就是将更新后的数据赋值给一个变量</span>
                    _vel_prev <span class="token operator">=</span> vel<span class="token punctuation">;</span>

                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
                    <span class="token comment" spellcheck="true">/**否则位置信息过时，将加速度信息清零**/</span>
                    <span class="token comment" spellcheck="true">/* position data is outdated, reset acceleration */</span>
                    <span class="token comment" spellcheck="true">// 没有更新就将数据重置，_vel_prev_t这个变量初始值为0，更新就将数据替换为lpos.timestamp，不更新就赋值为0</span>
                    _pos_acc<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _vel_prev<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    _vel_prev_t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
            <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* time from previous iteration */</span>
        <span class="token comment" spellcheck="true">// 从上次迭代开始的时间</span>
        hrt_abstime now <span class="token operator">=</span> <span class="token function">hrt_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//条件表达式 自右向左</span>
        <span class="token comment" spellcheck="true">//下面的constrain函数用于限定作用，限定规则：return (val &lt; min_val) ? min_val : ((val > max_val) ? max_val : val);</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span> dt <span class="token operator">=</span> math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">constrain</span><span class="token punctuation">(</span><span class="token punctuation">(</span>now <span class="token operator">-</span> _last_time<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1e6f</span><span class="token punctuation">,</span> _dt_min<span class="token punctuation">,</span> _dt_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _last_time <span class="token operator">=</span> now<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">update</span><span class="token punctuation">(</span>dt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            vehicle_attitude_s att <span class="token operator">=</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span><span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            att<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> sensors<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
            _q<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span>att<span class="token punctuation">.</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">/* the instance count is not used here */</span>
            <span class="token comment" spellcheck="true">// 这里不使用实例计数</span>
            _att_pub<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>att<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//最后发布给了vehicle_attitude,这也对应了最开始我们说的我们不能直接把陀螺仪的数据当成姿态信息，而应该</span>
                    <span class="token comment" spellcheck="true">//经过我们处理后才能使用。即vehicle_attitude的信息流为：订阅的是sensor combined，发布的是vehicle attitude</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token function">px4_lockstep_progress</span><span class="token punctuation">(</span>_lockstep_component<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><h2 id="参数更新"><a href="#参数更新" class="headerlink" title="参数更新"></a>参数更新</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">//查看参数是否更新，false查看参数是否更新，true获取参数，并由磁偏角更新四元数</span>
<span class="token keyword">void</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">update_parameters</span><span class="token punctuation">(</span>bool force<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// check for parameter updates</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_parameter_update_sub<span class="token punctuation">.</span><span class="token function">updated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> force<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// clear update</span>

        <span class="token comment" spellcheck="true">/**建立建构体pupdate，里面有更新的时间、是否更新、填充信息**/</span>
        parameter_update_s pupdate<span class="token punctuation">;</span>
        _parameter_update_sub<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pupdate<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// update parameters from storage</span>
        <span class="token comment" spellcheck="true">// 从存储中更新参数</span>
        <span class="token function">updateParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// disable mag fusion if the system does not have a mag</span>
        <span class="token comment" spellcheck="true">// 如果系统没有磁块，则禁用磁块融合</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_sys_has_mag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            _param_att_w_mag<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// if the weight is zero (=mag disabled), make sure the estimator initializes</span>
        <span class="token comment" spellcheck="true">// 如果权重为零( = mag disabled )，则确保估计器初始化</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_w_mag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> FLT_EPSILON<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">_mag</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
            <span class="token function">_mag</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
            <span class="token function">_mag</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">.</span>f<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// math::radians 将角度转换为弧度</span>
        <span class="token function">update_mag_declination</span><span class="token punctuation">(</span>math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">radians</span><span class="token punctuation">(</span>_param_att_mag_decl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><blockquote><p><strong>向量计算小知识</strong></p><table><thead><tr><th align="center"><strong>名称</strong></th><th align="center"><strong>标积/内积/数量积/点积</strong></th><th><strong>矢积/外积/向量积/叉积</strong></th></tr></thead><tbody><tr><td align="center"><strong>运算式</strong></td><td align="center"><strong>a</strong>·<strong>b</strong>=|<strong>a</strong>||<strong>b</strong>|·cosθ</td><td><strong>a</strong>×<strong>b</strong>=<strong>c</strong>，其中|<strong>c</strong>|=|<strong>a</strong>||<strong>b</strong>|·sinθ，<strong>c</strong>的方向遵守右手定则</td></tr><tr><td align="center"><strong>几何意义</strong></td><td align="center">向量<strong>a</strong>在向量<strong>b</strong>方向上的投影与向量<strong>b</strong>的模的乘积</td><td><strong>c</strong>是垂直a、b所在平面，且以|<strong>b</strong>|·sinθ为高、|<strong>a</strong>|为底的平行四边形的面积</td></tr><tr><td align="center"><strong>运算结果的区别</strong></td><td align="center">标量（常用于物理）/数量（常用于数学）</td><td>矢量（常用于物理）/向量（常用于数学）</td></tr></tbody></table></blockquote><blockquote><p><strong>向量归一化：</strong>一种是把数变为（0，1）之间的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%B0%8F%E6%95%B0/2172615">小数</a>，一种是把有量纲表达式变为<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%97%A0%E9%87%8F%E7%BA%B2/10675963">无量纲</a>表达式。主要是为了<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/944504">数据处理</a>方便提出来的，把<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE/5947370">数据</a>映射到0～1范围之内处理，更加便捷快速。</p><p>eg：{2.5 3.5 0.5 1.5}归一化后变成了{0.3125 0.4375 0.0625 0.1875}</p><p>解：2.5+3.5+0.5+1.5=8，</p><p>2.5/8=0.3125，</p><p>3.5/8=0.4375，</p><p>0.5/8=0.0625，</p><p>1.5/8=0.1875.</p><p>这个归一化就是将括号里面的总和变成1，然后写出每个数的比例。</p></blockquote><h2 id="初始化姿态估计"><a href="#初始化姿态估计" class="headerlink" title="初始化姿态估计"></a>初始化姿态估计</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">/***********init_attq() 函数作用：由加速度计和磁力计初始化旋转矩阵和四元数**************/</span>
bool
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">init_attq</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Rotation matrix can be easily constructed from acceleration and mag field vectors</span>
    <span class="token comment" spellcheck="true">// 旋转矩阵可以很容易地由加速度和磁场矢量构造</span>
    <span class="token comment" spellcheck="true">// 'k' is Earth Z axis (Down) unit vector in body frame</span>
    <span class="token comment" spellcheck="true">// ‘k’为体框架中的地球Z轴( Down )单位向量</span>

    <span class="token comment" spellcheck="true">//加速度传感器得到的三轴加速度   k是加速度的方向向量，在无人机平稳即无yaw时</span>
    Vector3f k <span class="token operator">=</span> <span class="token operator">-</span>_accel<span class="token punctuation">;</span>
                      <span class="token comment" spellcheck="true">//_accel已经在Run()中订阅，是经过赋值后的</span>
                                      <span class="token comment" spellcheck="true">//k为加速度传感器测量到加速度方向向量，由于第一次测量数据时无人机一般为平稳状态无运动状态，</span>
                                      <span class="token comment" spellcheck="true">//所以可以直接将测到的加速度视为重力加速度g，以此作为dcm旋转矩阵的第三行k</span>

    <span class="token comment" spellcheck="true">//k是朝下的向量</span>
    k<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//向量归一化，也就是向量除以他的长度</span>

    <span class="token comment" spellcheck="true">// 'i' is Earth X axis (North) unit vector in body frame, orthogonal with 'k'</span>
    <span class="token comment" spellcheck="true">// ‘i’为体框架中地球X轴(北)单位向量，与‘k’正交。</span>
    Vector3f i <span class="token operator">=</span> <span class="token punctuation">(</span>_mag <span class="token operator">-</span> k <span class="token operator">*</span> <span class="token punctuation">(</span>_mag <span class="token operator">*</span> k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">//施密特正交化解释如前言部分介绍</span>
                        <span class="token comment" spellcheck="true">//施密特正交化,强制使i与k垂直;因向量k已归一化，故分母等于1;</span>
                                              <span class="token comment" spellcheck="true">//这里的_mag是指北的，所以下面求得的R是默认飞机机头也是指向北</span>

    <span class="token comment" spellcheck="true">//i是朝北地向量</span>
    i<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment" spellcheck="true">//向量归一化，也就是向量除以他的长度</span>

    <span class="token comment" spellcheck="true">// 'j' is Earth Y axis (East) unit vector in body frame, orthogonal with 'k' and 'i'</span>
    <span class="token comment" spellcheck="true">// ' j '是e坐标中地球Y轴(东方)单位向量，与' k '和' i '正交。</span>

    <span class="token comment" spellcheck="true">//j是朝东的向量</span>
    Vector3f j <span class="token operator">=</span> k <span class="token operator">%</span> i<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Fill rotation matrix</span>
    Dcmf R<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//3 X 3 的旋转矩阵</span>
    R<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> i<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//北  将i向量填入矩阵第一行</span>
    R<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> j<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//东  将j向量填入矩阵第二行</span>
    R<span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> k<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//下  将k向量填入矩阵第三行，注意：从这里可知该旋转矩阵为b系到n系</span>

    <span class="token comment" spellcheck="true">// Convert to quaternion</span>
    <span class="token comment" spellcheck="true">// 将R矩阵转换为四元数</span>
    _q <span class="token operator">=</span> R<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Compensate for magnetic declination   补偿飞机的磁方位角，因为前面求得q是默认飞机指向北，但起飞时飞机不一定指向北</span>
    Quatf decl_rotation <span class="token operator">=</span> <span class="token function">Eulerf</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> _mag_decl<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/**将旋转矩阵仅仅通过yaw偏航的四元数表示**/</span>
    _q <span class="token operator">=</span> _q <span class="token operator">*</span> decl_rotation<span class="token punctuation">;</span>

    _q<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**归一化**/</span>  <span class="token comment" spellcheck="true">/**此时的q才是真正的初始的q**/</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>    <span class="token comment" spellcheck="true">/**判断是否发散**/</span>
        <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        _q<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0.95f</span> <span class="token operator">&amp;&amp;</span> _q<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1.05f</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        _inited <span class="token operator">=</span> true<span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">/**初始化完成**/</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        _inited <span class="token operator">=</span> false<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/**初始化失败**/</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> _inited<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><h2 id="更新、将四元数进行修正更新"><a href="#更新、将四元数进行修正更新" class="headerlink" title="更新、将四元数进行修正更新"></a>更新、将四元数进行修正更新</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">//初始化仅进行一次</span>
bool
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">float</span> dt<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_inited<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_data_good<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**在前面Run()函数中如果传感器数据订阅正常，data_good就为true**/</span>
            <span class="token keyword">return</span> false<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">init_attq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/**没有初始化（前提：传感器数据订阅正常）就初始化**/</span>
                            <span class="token comment" spellcheck="true">//并且注意：init在一次飞行trampoline中只执行一次，</span>
                <span class="token comment" spellcheck="true">// 因为以后的四元数和转换矩阵由输出的角速度经过龙格库塔法求，而飞机在初始飞行时就需要通过init_attq求转换矩阵</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">/**前面的init_attq等都完成就继续往下执行**/</span>
    Quatf q_last <span class="token operator">=</span> _q<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**注意：此时四元数_q已经有内容了，此处的q_last的作用为给q弄一个备份，可从最后一个if看出**/</span>

    <span class="token comment" spellcheck="true">// Angular rate of correction   修正角速率,下面的是重点</span>
    Vector3f corr<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//_gyro是上面Run()经过赋值得到的</span>
    <span class="token keyword">float</span> spinRate <span class="token operator">=</span> _gyro<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">/**定义一个变量：旋转速率，length函数为平方和开方**/</span>

    <span class="token comment" spellcheck="true">//首先判断是使用什么mode做修正的，比如vision、mocap、acc和mag，这里我们着重分析用acc和mag做修正，另外两个同理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_ext_hdg_m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _ext_hdg_good<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_ext_hdg_m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Vision heading correction  对基于视觉的航向模式进行修正</span>
            <span class="token comment" spellcheck="true">// Project heading to global frame and extract XY component</span>
            Vector3f vision_hdg_earth <span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate</span><span class="token punctuation">(</span>_vision_hdg<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/**将b系转为e系**/</span>
            <span class="token keyword">float</span> vision_hdg_err <span class="token operator">=</span> <span class="token function">wrap_pi</span><span class="token punctuation">(</span><span class="token function">atan2f</span><span class="token punctuation">(</span><span class="token function">vision_hdg_earth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">vision_hdg_earth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Project correction to body frame</span>
            corr <span class="token operator">+</span><span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate_inversed</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span>vision_hdg_err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> _param_att_w_ext_hdg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_ext_hdg_m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Mocap heading correction</span>
            <span class="token comment" spellcheck="true">// Project heading to global frame and extract XY component</span>
            Vector3f mocap_hdg_earth <span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate</span><span class="token punctuation">(</span>_mocap_hdg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span> mocap_hdg_err <span class="token operator">=</span> <span class="token function">wrap_pi</span><span class="token punctuation">(</span><span class="token function">atan2f</span><span class="token punctuation">(</span><span class="token function">mocap_hdg_earth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mocap_hdg_earth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// Project correction to body frame</span>
            corr <span class="token operator">+</span><span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate_inversed</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span>mocap_hdg_err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> _param_att_w_ext_hdg<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">//磁力计校准 外部导航失效或不使用</span>
    <span class="token comment" spellcheck="true">//将磁力计读数从机体坐标系转换到导航坐标系</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_ext_hdg_m<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>_ext_hdg_good<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Magnetometer correction</span>
        <span class="token comment" spellcheck="true">// Project mag field vector to global frame and extract XY component</span>
        <span class="token comment" spellcheck="true">// 将mag字段向量投影到全局框架并提取XY组件</span>
        Vector3f mag_earth <span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate</span><span class="token punctuation">(</span>_mag<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">/**将b系转为e系**/</span>   <span class="token comment" spellcheck="true">//公式如图-1</span>

        <span class="token comment" spellcheck="true">//只考虑Vector&lt;3> mag_earth中的前两维的数据mag_earth(1)和mag_earth(0)（即x、y，忽略z轴上的偏移），通</span>
               <span class="token comment" spellcheck="true">//过arctan（mag_earth(1),mag_earth(0)）得到的角度和前面根据经纬度获取的磁方位角做差值得到误差角度mag_err</span>
              <span class="token comment" spellcheck="true">//wrap_pi函数是用于限定结果-pi到pi的函数，大于pi则与2pi做差取补，小于-pi则与2pi做和取补</span>
              <span class="token comment" spellcheck="true">//注意1：这里在修正磁力计时用到的是有gps校准时的修正办法，即下面的减去自动获取的磁偏角。没有gps的校准方法见ppt(我找找)</span>
             <span class="token comment" spellcheck="true">//注意2：这里校正的方法是用磁力计计算的磁偏角与gps得出来的做差，然后转换到b系。</span>

        <span class="token keyword">float</span> mag_err <span class="token operator">=</span> <span class="token function">wrap_pi</span><span class="token punctuation">(</span><span class="token function">atan2f</span><span class="token punctuation">(</span><span class="token function">mag_earth</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mag_earth</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> _mag_decl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//atan2f: 2 表示两个输入参数; 支持四象限内角度换算; 输出弧度值; </span>
        <span class="token comment" spellcheck="true">//将磁力计的读数由向量换算到角度; 该角度减去磁偏，得到磁场偏差; </span>
        <span class="token comment" spellcheck="true">//_mag_decl 由GPS得到; </span>
        
        <span class="token keyword">float</span> gainMult <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">float</span> fifty_dps <span class="token operator">=</span> <span class="token number">0.873f</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">//float spinRate = _gyro.length();   </span><span class="token comment" spellcheck="true">/**定义一个变量：旋转速率，length函数为平方和开方**/</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>spinRate <span class="token operator">></span> fifty_dps<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            gainMult <span class="token operator">=</span> math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">min</span><span class="token punctuation">(</span>spinRate <span class="token operator">/</span> fifty_dps<span class="token punctuation">,</span> <span class="token number">10.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Project magnetometer correction to body frame</span>
        <span class="token comment" spellcheck="true">//下面*Vector&lt;3>(0.0f, 0.0f, -mag_err))是因为raw本质上应该由磁力计产生的水平</span>
        <span class="token comment" spellcheck="true">// 磁向量与gps产生的水平磁向量叉乘得到，而叉乘得到的正好向下</span>
        <span class="token comment" spellcheck="true">//将磁场偏差转换到机体坐标系，并乘以其对应权重; </span>
        <span class="token comment" spellcheck="true">//图2</span>
        corr <span class="token operator">+</span><span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">conjugate_inversed</span><span class="token punctuation">(</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token operator">-</span>mag_err<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> _param_att_w_mag<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> gainMult<span class="token punctuation">;</span>
        
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    _q<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这里的归一化用于校正update_mag_declination后的偏差。</span>


    <span class="token comment" spellcheck="true">// Accelerometer correction   加速度计修正</span>
    <span class="token comment" spellcheck="true">// Project 'k' unit vector of earth frame to body frame  将k从地坐标系投影到机体坐标系</span>
    <span class="token comment" spellcheck="true">// Vector3f k = _q.conjugate_inversed(Vector3f(0.0f, 0.0f, 1.0f));   //从n系到b系</span>
    <span class="token comment" spellcheck="true">// Optimized version with dropped zeros</span>
    <span class="token comment" spellcheck="true">//下面的k是n系中重力的单位向量转换到b系中，即左乘旋转矩阵得到的</span>
    Vector3f <span class="token function">k</span><span class="token punctuation">(</span>
        <span class="token number">2.0f</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token number">2.0f</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">//总的受到合力的方向（_accel）减去机体加速度方向（_pos_acc）得到g的方向，即总加速度（加速度获取）减去机体运动加速度获取重力加速度</span>
       <span class="token comment" spellcheck="true">//重力加速度的方向是导航坐标系下的z轴，加上运动加速度之后，总加速度的方向就不是与导航坐标系的天或地平行了，所以要消除这个误差，即“_accel-_pos_acc”</span>
        <span class="token comment" spellcheck="true">//这里与k差乘得到的是与重力方向的夹角sinx，约等于x，即roll和pitch</span>

    <span class="token comment" spellcheck="true">// If we are not using acceleration compensation based on GPS velocity,  如果我们不使用基于GPS速度的加速度补偿，</span>
    <span class="token comment" spellcheck="true">// fuse accel data only if its norm is close to 1 g (reduces drift).  只有当其范数接近1 g (减小漂移)时，才对acel数据进行融合。</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> accel_norm_sq <span class="token operator">=</span> _accel<span class="token punctuation">.</span><span class="token function">norm_squared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> upper_accel_limit <span class="token operator">=</span> CONSTANTS_ONE_G <span class="token operator">*</span> <span class="token number">1.1f</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">float</span> lower_accel_limit <span class="token operator">=</span> CONSTANTS_ONE_G <span class="token operator">*</span> <span class="token number">0.9f</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>_param_att_acc_comp<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>accel_norm_sq <span class="token operator">></span> lower_accel_limit <span class="token operator">*</span> lower_accel_limit<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                      <span class="token punctuation">(</span>accel_norm_sq <span class="token operator">&lt;</span> upper_accel_limit <span class="token operator">*</span> upper_accel_limit<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>


        <span class="token comment" spellcheck="true">// %是叉乘的意思</span>
        <span class="token comment" spellcheck="true">//向量 k 是重力加速度向量(0,0,1)转换到机体坐标系; </span>
        <span class="token comment" spellcheck="true">//_accel 是加速度计的读数; </span>
        <span class="token comment" spellcheck="true">//_pos_acc 是由位置估计(GPS) 微分得到的加速度; </span>
        <span class="token comment" spellcheck="true">//_accel - _pos_acc 表示飞行器加速度向量减去其水平分量; </span>
        <span class="token comment" spellcheck="true">//k 与 (_accel - _pos_acc)叉乘，得到偏差;</span>
        
        <span class="token comment" spellcheck="true">//公式看图-3</span>
        <span class="token comment" spellcheck="true">//下面是另一种理解</span>
        <span class="token comment" spellcheck="true">//总的受到合力的方向（_accel）减去机体加速度方向（_pos_acc）得到g的方向，即总加速度（加速度获取）减去机体运动加速度获取重力加速度，然后姿态矩阵的不是行就是列来与纯重力加速度来做叉积，算出误差。因为运动加速度是有害的干扰，必须减掉。算法的理论基础是[0,0,1]与姿态矩阵相乘。</span>
        <span class="token comment" spellcheck="true">//该差值获取的重力加速度的方向是导航坐标系下的z轴，加上运动加速度之后，总加速度的方向就不是与导航坐标系的天或地平行了，所以要消除这个误差，即“_accel-_pos_acc”。然后叉乘z轴向量得到误差，进行校准 。</span>
        
        corr <span class="token operator">+</span><span class="token operator">=</span> <span class="token punctuation">(</span>k <span class="token operator">%</span> <span class="token punctuation">(</span>_accel <span class="token operator">-</span> _pos_acc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> _param_att_w_acc<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Gyro bias estimation   陀螺偏差</span>
    <span class="token comment" spellcheck="true">//spinRate 旋转速率</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>spinRate <span class="token operator">&lt;</span> <span class="token number">0.175f</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//得到陀螺仪修正值 </span>
        <span class="token comment" spellcheck="true">//此处修正值为 mahony 滤波的 pi 控制器的 积分部分;</span>
        <span class="token comment" spellcheck="true">//因为 _gyro_bias 不归零，故不断累积; </span>
        
        <span class="token comment" spellcheck="true">//公式见图-4</span>
        
        _gyro_bias <span class="token operator">+</span><span class="token operator">=</span> corr <span class="token operator">*</span> <span class="token punctuation">(</span>_param_att_w_gyro_bias<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> dt<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//对应积分控制</span>

        <span class="token comment" spellcheck="true">//对_gyro_bias做约束处理。</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token function">_gyro_bias</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> math<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">constrain</span><span class="token punctuation">(</span><span class="token function">_gyro_bias</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span>_bias_max<span class="token punctuation">,</span> _bias_max<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    _rates <span class="token operator">=</span> _gyro <span class="token operator">+</span> _gyro_bias<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//角速度 = 陀螺仪的测量值 + 误差校准  图5</span>

    <span class="token comment" spellcheck="true">// Feed forward gyro</span>

    <span class="token comment" spellcheck="true">// pi控制器的体现，对应比例部分</span>
    corr <span class="token operator">+</span><span class="token operator">=</span> _rates<span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//corr为update函数中定义的变量，所以每次进入update()函数中时会刷新corr变量的数据</span>
    <span class="token comment" spellcheck="true">//这里的 corr = (Ea+Em) + (Ea+Em)*dt + gyro; </span>
    <span class="token comment" spellcheck="true">//个人认为这里的 corr 才是更新后的角速度;</span>
    <span class="token comment" spellcheck="true">//参看公式如图6</span>
    
    <span class="token comment" spellcheck="true">// Apply correction to state</span>
    <span class="token comment" spellcheck="true">//最后就是使用修正的数据更新四元数，并把_rates和_gyro_bias置零便于下次调用时使用。</span>
    
    _q <span class="token operator">+</span><span class="token operator">=</span> _q<span class="token punctuation">.</span><span class="token function">derivative1</span><span class="token punctuation">(</span>corr<span class="token punctuation">)</span> <span class="token operator">*</span> dt<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//用龙格库塔法更新四元数</span>
    <span class="token comment" spellcheck="true">//更新四元数，derivative为求导函数，使用一阶龙格库塔求导。  公式参看图-6</span>

    <span class="token comment" spellcheck="true">// Normalize quaternion</span>
    _q<span class="token punctuation">.</span><span class="token function">normalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment" spellcheck="true">//四元数不合适就将其重置</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">PX4_ISFINITE</span><span class="token punctuation">(</span><span class="token function">_q</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 如果数据不合适就恢复备份的q，即q_last</span>

        <span class="token comment" spellcheck="true">// Reset quaternion to last good state</span>
        <span class="token comment" spellcheck="true">// 将四元数重置为最后一个好状态</span>
        _q <span class="token operator">=</span> q_last<span class="token punctuation">;</span>
        _rates<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _gyro_bias<span class="token punctuation">.</span><span class="token function">zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> false<span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> true<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//更新完四元数后，我们跳到update函数被调用的地方，即422行，发现后面将更新后的姿态信息发布出去了，到此整个过程结束</span>
<span class="token comment" spellcheck="true">// 调用函数为</span>
<span class="token comment" spellcheck="true">// if (update(dt)) &amp;#123;</span>

<span class="token comment" spellcheck="true">//&amp;#125;</span>
</code></pre><p><strong>以上部分公式如下：</strong></p><p><img src="/posts/e0b/1.png" alt="图1"></p><p><img src="/posts/e0b/2.png" alt="图2"></p><p><img src="/posts/e0b/3.png" alt="图3"></p><p><img src="/posts/e0b/4.png" alt="图4"></p><p><img src="/posts/e0b/5.png" alt="图5"></p><p><img src="/posts/e0b/6.png" alt="图6"></p><h2 id="更新偏航角"><a href="#更新偏航角" class="headerlink" title="更新偏航角"></a>更新偏航角</h2><pre class="language-c"><code class="language-c"><span class="token comment" spellcheck="true">/**偏航角改变立刻更新磁方位角**/</span>
<span class="token keyword">void</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">update_mag_declination</span><span class="token punctuation">(</span><span class="token keyword">float</span> new_declination<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Apply initial declination or trivial rotations without changing estimation</span>
    <span class="token comment" spellcheck="true">// 忽略微小旋转（比如机体的微小震动），继续沿用之前的磁方位角</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_inited <span class="token operator">||</span> <span class="token function">fabsf</span><span class="token punctuation">(</span>new_declination <span class="token operator">-</span> _mag_decl<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.0001f</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        _mag_decl <span class="token operator">=</span> new_declination<span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//转动较大时，修正姿态（q）和更新磁方位角</span>
        <span class="token comment" spellcheck="true">// Immediately rotate current estimation to avoid gyro bias growth</span>
        Quatf decl_rotation <span class="token operator">=</span> <span class="token function">Eulerf</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> new_declination <span class="token operator">-</span> _mag_decl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 偏航角生成的四元数，生成方法是令另外2个角度为0,使用欧拉角转四元数公式</span>
        _q <span class="token operator">=</span> _q <span class="token operator">*</span> decl_rotation<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//此处两个四元数相乘表示角度相加，因为在数学上q1*q2表示q1q2这个合成动作，所以此处修正了四元数</span>
        _mag_decl <span class="token operator">=</span> new_declination<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//使用新的磁偏角</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><h2 id="一些配置函数"><a href="#一些配置函数" class="headerlink" title="一些配置函数"></a>一些配置函数</h2><pre class="language-c"><code class="language-c"><span class="token keyword">int</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">custom_command</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">print_usage</span><span class="token punctuation">(</span><span class="token string">"unknown command"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">int</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">task_spawn</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    AttitudeEstimatorQ <span class="token operator">*</span>instance <span class="token operator">=</span> new <span class="token function">AttitudeEstimatorQ</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        _object<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _task_id <span class="token operator">=</span> task_id_is_work_queue<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance<span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> PX4_OK<span class="token punctuation">;</span>
        <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">PX4_ERR</span><span class="token punctuation">(</span><span class="token string">"alloc failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    delete instance<span class="token punctuation">;</span>
    _object<span class="token punctuation">.</span><span class="token function">store</span><span class="token punctuation">(</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _task_id <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> PX4_ERROR<span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">int</span>
AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">print_usage</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>reason<span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reason<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
        <span class="token function">PX4_WARN</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

    <span class="token function">PRINT_MODULE_DESCRIPTION</span><span class="token punctuation">(</span>
        R"<span class="token function">DESCR_STR</span><span class="token punctuation">(</span>
### Description
Attitude estimator q<span class="token punctuation">.</span>

<span class="token punctuation">)</span>DESCR_STR"<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PRINT_MODULE_USAGE_NAME</span><span class="token punctuation">(</span><span class="token string">"AttitudeEstimatorQ"</span><span class="token punctuation">,</span> <span class="token string">"estimator"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PRINT_MODULE_USAGE_COMMAND</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PRINT_MODULE_USAGE_DEFAULT_COMMANDS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> __EXPORT <span class="token keyword">int</span> <span class="token function">attitude_estimator_q_main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> AttitudeEstimatorQ<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span>
</code></pre><p>后续继续补充…</p></div><hr><div class="reprint" id="reprint-statement"><div class="reprint__author"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-user">文章作者: </i></span><span class="reprint-info"><a href="/about" rel="external nofollow noreferrer">xiao J</a></span></div><div class="reprint__type"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-link">文章链接: </i></span><span class="reprint-info"><a href="https://Jcs-blog.github.io/posts/e0b.html">https://Jcs-blog.github.io/posts/e0b.html</a></span></div><div class="reprint__notice"><span class="reprint-meta" style="font-weight:700"><i class="fas fa-copyright">版权声明: </i></span><span class="reprint-info">本博客所有文章除特別声明外，均采用 <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a> 许可协议。转载请注明来源 <a href="/about" target="_blank">xiao J</a> !</span></div></div><script async defer>document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }</script><div class="tag_share" style="display:block"><div class="post-meta__tag-list" style="display:inline-block"><div class="article-tag"><a href="/tags/%E6%97%A0%E4%BA%BA%E6%9C%BA%E7%AE%97%E6%B3%95/"><span class="chip bg-color">无人机算法</span></a></div></div><div class="post_share" style="zoom:80%;width:fit-content;display:inline-block;float:right;margin:-.15rem 0"><link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css"><div id="article-share"><div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div><script src="/libs/share/js/social-share.min.js"></script></div></div></div><style>#reward{margin:40px 0;text-align:center}#reward .reward-link{font-size:1.4rem;line-height:38px}#reward .btn-floating:hover{box-shadow:0 6px 12px rgba(0,0,0,.2),0 5px 15px rgba(0,0,0,.2)}#rewardModal{width:320px;height:350px}#rewardModal .reward-title{margin:15px auto;padding-bottom:5px}#rewardModal .modal-content{padding:10px}#rewardModal .close{position:absolute;right:15px;top:15px;color:rgba(0,0,0,.5);font-size:1.3rem;line-height:20px;cursor:pointer}#rewardModal .close:hover{color:#ef5350;transform:scale(1.3);-moz-transform:scale(1.3);-webkit-transform:scale(1.3);-o-transform:scale(1.3)}#rewardModal .reward-tabs{margin:0 auto;width:210px}.reward-tabs .tabs{height:38px;margin:10px auto;padding-left:0}.reward-content ul{padding-left:0!important}.reward-tabs .tabs .tab{height:38px;line-height:38px}.reward-tabs .tab a{color:#fff;background-color:#ccc}.reward-tabs .tab a:hover{background-color:#ccc;color:#fff}.reward-tabs .wechat-tab .active{color:#fff!important;background-color:#22ab38!important}.reward-tabs .alipay-tab .active{color:#fff!important;background-color:#019fe8!important}.reward-tabs .reward-img{width:210px;height:210px}</style><div id="reward"><a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a><div id="rewardModal" class="modal"><div class="modal-content"><a class="close modal-close"><i class="fas fa-times"></i></a><h4 class="reward-title">你的赏识是我前进的动力</h4><div class="reward-content"><div class="reward-tabs"><ul class="tabs row"><li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li><li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li></ul><div id="alipay"><img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码"></div><div id="wechat"><img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码"></div></div></div></div></div></div><script>$(function(){$(".tabs").tabs()})</script></div></div><article id="prenext-posts" class="prev-next articles"><div class="row article-row"><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge left-badge text-color"><i class="fas fa-chevron-left"></i>&nbsp;上一篇</div><div class="card"><a href="/posts/undefined.html"><div class="card-image"><img src="/medias/featureimages/2.jpg" class="responsive-img" alt="常用快捷键集锦"> <span class="card-title">常用快捷键集锦</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2021-01-13 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> xiao J</span></div></div><div class="card-action article-tags"><a href="/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE%E9%9B%86%E9%94%A6/"><span class="chip bg-color">快捷键集锦</span></a></div></div></div><div class="article col s12 m6" data-aos="fade-up"><div class="article-badge right-badge text-color">下一篇&nbsp;<i class="fas fa-chevron-right"></i></div><div class="card"><a href="/posts/5e00.html"><div class="card-image"><img src="/medias/featureimages/17.jpg" class="responsive-img" alt="新建Mavlink消息"> <span class="card-title">新建Mavlink消息</span></div></a><div class="card-content article-content"><div class="summary block-with-text"></div><div class="publish-info"><span class="publish-date"><i class="far fa-clock fa-fw icon-date"></i>2021-01-12 </span><span class="publish-author"><i class="fas fa-user fa-fw"></i> xiao J</span></div></div><div class="card-action article-tags"><a href="/tags/PX4%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/"><span class="chip bg-color">PX4二次开发教程</span></a></div></div></div></div></article></div><script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script><script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script><script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script><script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script></div><div id="toc-aside" class="expanded col l3 hide-on-med-and-down"><div class="toc-widget card" style="background-color:#fff"><div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div><div id="toc-content"></div></div></div></div><div id="floating-toc-btn" class="hide-on-med-and-down"><a class="btn-floating btn-large bg-color"><i class="fas fa-list-ul"></i></a></div><script src="/libs/tocbot/tocbot.min.js"></script><script>$(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });</script></main><footer class="page-footer bg-color"><div class="container row center-align" style="margin-bottom:15px!important"><div class="col s12 m8 l8 copy-right">Copyright&nbsp;&copy; <span id="year">2021</span> <span id="year">2021</span> <a href="/about" target="_blank">xiao J</a> |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a> |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a><br><span id="busuanzi_container_site_pv">|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv" class="white-color"></span>&nbsp;次 </span><span id="busuanzi_container_site_uv">|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv" class="white-color"></span>&nbsp;人</span><br><span id="sitetime">载入运行时间...</span><script>function siteTime(){var e=36e5,t=24*e,n=new Date,o="2021",r=n.getFullYear(),a=n.getMonth()+1,i=n.getDate(),l=n.getHours(),m=n.getMinutes(),M=n.getSeconds(),g=Date.UTC(o,"1","1","0","0","0"),d=Date.UTC(r,a,i,l,m,M)-g,s=Math.floor(d/31536e6),u=Math.floor(d/t-365*s),T=Math.floor((d-(365*s+u)*t)/e),c=Math.floor((d-(365*s+u)*t-T*e)/6e4),f=Math.floor((d-(365*s+u)*t-T*e-6e4*c)/1e3);o==r?(document.getElementById("year").innerHTML=r,document.getElementById("sitetime").innerHTML="本站已安全运行 "+u+" 天 "+T+" 小时 "+c+" 分钟 "+f+" 秒"):(document.getElementById("year").innerHTML=o+" - "+r,document.getElementById("sitetime").innerHTML="本站已安全运行 "+s+" 年 "+u+" 天 "+T+" 小时 "+c+" 分钟 "+f+" 秒")}setInterval(siteTime,1e3)</script><br></div><div class="col s12 m4 l4 social-link"><a href="https://blog.csdn.net/qq_43742383" class="tooltipped" target="_blank" data-tooltip="关注我的CSDN: https://blog.csdn.net/qq_43742383" data-position="top" data-delay="50"><i class="fab fa-csdn">C</i> </a><a href="https://github.com/Jcs-blog" class="tooltipped" target="_blank" data-tooltip="访问我的Gitee" data-position="top" data-delay="50"><i class="fab fa-git"></i> </a><a href="https://github.com/Jcs-blog" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50"><i class="fab fa-github"></i> </a><a href="mailto:1510929829@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50"><i class="fas fa-envelope-open"></i> </a><a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1510929829" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1510929829" data-position="top" data-delay="50"><i class="fab fa-qq"></i></a></div></div></footer><div class="progress-bar"></div><div id="searchModal" class="modal"><div class="modal-content"><div class="search-header"><span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span> <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字" class="search-input"></div><div id="searchResult"></div></div></div><script type="text/javascript">$(function(){!function(t,s,i){"use strict";$.ajax({url:t,dataType:"xml",success:function(t){var e=$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get(),n=document.getElementById(s),r=document.getElementById(i);n.addEventListener("input",function(){var f='<ul class="search-result-list">',m=this.value.trim().toLowerCase().split(/[\s\-]+/);r.innerHTML="",this.value.trim().length<=0||(e.forEach(function(t){var n,e,r,s,i,l=!0,a=t.title.trim().toLowerCase(),c=t.content.trim().replace(/<[^>]+>/g,"").toLowerCase(),u=0===(u=t.url).indexOf("/")?t.url:"/"+u,o=-1,h=-1;""!==a&&""!==c&&m.forEach(function(t,e){n=a.indexOf(t),o=c.indexOf(t),n<0&&o<0?l=!1:(o<0&&(o=0),0===e&&(h=o))}),l&&(f+="<li><a href='"+u+"' class='search-result-title'>"+a+"</a>",e=t.content.trim().replace(/<[^>]+>/g,""),0<=h&&(s=h+80,(r=h-20)<0&&(r=0),0===r&&(s=100),s>e.length&&(s=e.length),i=e.substr(r,s),m.forEach(function(t){var e=new RegExp(t,"gi");i=i.replace(e,'<em class="search-keyword">'+t+"</em>")}),f+='<p class="search-result">'+i+"...</p>"),f+="</li>")}),f+="</ul>",r.innerHTML=f)})}})}("/search.xml","searchInput","searchResult")})</script><div id="backTop" class="top-scroll"><a class="btn-floating btn-large waves-effect waves-light" href="#!"><i class="fas fa-arrow-up"></i></a></div><script src="/libs/materialize/materialize.min.js"></script><script src="/libs/masonry/masonry.pkgd.min.js"></script><script src="/libs/aos/aos.js"></script><script src="/libs/scrollprogress/scrollProgress.min.js"></script><script src="/libs/lightGallery/js/lightgallery-all.min.js"></script><script src="/js/matery.js"></script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/libs/others/clicklove.js" async></script><script type="text/javascript" color="122 103 238" opacity="0.7" zindex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><script src="/libs/instantpage/instantpage.js" type="module"></script></body></html>